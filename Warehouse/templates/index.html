<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ingredients</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-size: cover; /* Ensures the image covers the entire background */
            background-position: center center; /* Centers the image */
            height: 100vh; /* Ensures the background takes the full viewport height */
            margin: 0; /* Removes any default margin */
            padding: 0; /* Removes any default padding */
            box-sizing: border-box; /* Ensures padding and borders are included in the element's total width and height */
        }
        /* Fixed header styling */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

.total-products {
    background-color: #4CAF50; /* Slightly darker background */
    border: 2px solid white;
    padding: 5px 10px;
    border-radius: 5px;
    margin-left: 15px; /* Space between the heading and the total count */
    font-size: 16px;
    color: white;
}
        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .header .add-button {
            background-color: white;
            color: #4CAF50;
            padding: 10px 20px;
            margin-right: 50px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px; /* Add margin to offset the fixed header */
        }

        table, th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f4f4f4;
        }
        tr {
            background-color: #f4f4f4;
        }

        form {
            margin-top: 20px;
        }

        .modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black background with opacity */
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

/* Modal content */
.modal-content {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    width: 400px;
    max-width: 90%;
    max-height: 80vh; /* Ensure modal doesn't overflow */
    overflow-y: auto; /* Add vertical scrolling if content is too long */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    text-align: left;
}

/* Close button style */
.close-button {
    background-color: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 16px;
    float: right;
}

/* Form labels */
.form-container label {
    display: block;
    margin-bottom: 10px;
    text-align: left;
}

/* Form input fields */
.form-container input {
    width: 100%;
    padding: 8px;
    margin: 5px 0 15px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
}


        .add-button:hover {
            background-color: #3e8e41;
            color: white;
        }
        .prod-headings {
    margin-top: 140px;
    margin-left: 30px;
    text-align: center;
    color: #fff;
    -webkit-text-stroke: 2px #4CAF50;
    font-weight: bold;
    font-size: 30px;
    text-transform: uppercase;
    background: linear-gradient(to right, #4CAF50, #fff);
    -webkit-background-clip: text;
    color: transparent;
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
    letter-spacing: 1px;
    transition: all 0.3s ease;
}

.prod-headings:hover {
    color: #4CAF50;
    text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
    transform: scale(1.05);
}

.product-table {
    display: block; /* Hidden by default, will be shown when the heading is clicked */
}

    </style>
    <style>
        .popup {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }
        
        .popup img {
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .popup .close-button {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 69px;
            color: white;
            cursor: pointer;
            background: transparent;
            border: none;
        }
        
        /* The close button */
.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}
.scroll-bruh {
    max-height: 250px; /* Limit the height */
    overflow-y: auto;  /* Enable vertical scrolling */
    padding-right: 10px; /* Adds space to the right of the list for the scrollbar */
}

        </style>     
        <style>
            /* Notify Popup (First Div) */
            .popup1, .popup2 {
    display: none;
    position: fixed;
    top: 50%; /* Centered vertically */
    left: 50%;
    transform: translate(-50%, -50%); /* Centered horizontally */
    width: 60%;
    max-width: 800px; /* Limit max width */
    z-index: 1000;
    justify-content: center;
    align-items: center;
    background-color: rgb(26, 25, 25); /* Background for the popup */
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    text-align: center;
    overflow: hidden;
}

/* Scrollable area for each section */
.popup-content {
    display: flex;
    flex-direction: column;
    height: 600px; /* Set height for scrolling */
    overflow: hidden;
}

/* Separate scrollable sections */
.popup1-scroll {
    overflow-y: auto;
    flex-grow: 1;
    padding: 10px;
    max-height: 100px; /* Max height for scrollable content */
    background-color: #333; /* Dark background for content */
    color: #fff;
    border-radius: 5px;
    margin-bottom: 10px;
}
/* Separate scrollable sections */
.popup2-scroll {
    overflow-y: auto;
    flex-grow: 1;
    padding: 10px;
    max-height: 300px; /* Max height for scrollable content */
    background-color: #333; /* Dark background for content */
    color: #fff;
    border-radius: 5px;
    margin-bottom: 10px;
}

/* Close button styling */
.close-btn {
    font-size: 24px;
    font-weight: bold;
    color: red;
    cursor: pointer;
    position: absolute;
    top: 10px;
    right: 10px;
}

.out-of-stock-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    font-size: 16px;
    text-align: left;
    background-color: black; /* Black background */
}

.out-of-stock-table th, .out-of-stock-table td {
    border: 1px solid #3b3b3b;
    background-color: black; /* Black background */
    padding: 8px;
}

.out-of-stock-table th {
    background-color: #702a2a;
    font-weight: bold;
}
/* Popup Styles */
.popup3 {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 50%;
    top: 10%; /* Top Center */
    transform: translateX(-50%); /* Center horizontally */
    width: 80%; /* Increased width */
    max-width: 90%; /* Ensure it doesn't exceed screen size */
    max-height: 80%; /* Limit height */
    background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent background */
    overflow-y: auto; /* Allow scrolling if content exceeds height */
    box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.3); /* Optional shadow */
}

.popup3-content {
    background-color: rgb(24, 24, 24);
    border-radius: 10px;
    width: 100%; /* Ensure content spans full width of pop-up */
    overflow-y: auto; /* Add scrolling inside pop-up content if needed */
    box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.3); /* Optional shadow */
}

.popup3 .close6 {
    color: #aaa;
    margin-right:20px;
    margin-top:20px;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.popup3 .close6:hover,
.popup3 .close6:focus {
    color: black;
    text-decoration: none;
}

/* Orders Table */
.orders-table {
    width: 100%; /* Full width inside pop-up */
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 16px;
    text-align: center;
    background-color: black; /* Black background */
    color: white; /* White text */
}

.orders-table th,
.orders-table td {
    background-color: black;
    border: 1px solid white;
    padding: 8px;
}

.orders-table th {
    background-color: #444; /* Darker header background */
}

.orders-table tr:nth-child(even) {
    background-color: #333; /* Alternate row color */
}

.orders-table tr:hover {
    background-color: #555; /* Hover effect */
}

#loginPopup {
    display: none; /* Hide by default to prevent flickering */
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(41, 41, 41, 0.932);
    z-index: 1001;
    overflow: hidden;
}

#loginPopup .popup-content {
    background: rgba(255, 255, 255, 0.85);
    margin-top: 10%;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    width: 500px;
    height: 500px;
    z-index: 2;
}

#ordersChart69 {
            max-width: 600px;
            max-height: 400px;
            margin: auto;
        }

#loginPopup input {
    width: 90%;
    height:10%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #4CAF50;
    border-radius: 5px;
}

#loginPopup button {
    background: #4CAF50;
    color: white;
    padding: 15px 30px; /* Increased padding for larger size */
    font-size: 18px; /* Increased font size */
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#loginPopup button:hover {
    background: #45a049;
}

.hidden {
            display: none;
        }
        .delete-button {
    background-color: red;
    color: white;
    border: none;
    padding: 10px 15px;
    margin-top: 10px;
    cursor: pointer;
    font-size: 16px;
    border-radius: 5px;
}

.delete-button:hover {
    background-color: darkred;
}

.modal9 {
    position: fixed;
    z-index: 999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal9-content {
    background-color: #242424;
    border: 1px solid black;
    padding: 20px;
    width: 100%; /* Adjust as needed */
    max-width: 100%; /* Restrict the max width */
    max-height: 100%; /* Ensure it fits within the screen height */
    overflow: auto; /* Add scrollbars if content overflows */
    text-align: center;
    box-sizing: border-box;
    border-radius: 8px; /* Optional: Add rounded corners for aesthetics */
}

.modal9-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
}

.modal9-content > div {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    
}

/* Increase canvas sizes */
canvas {
    width: 600px !important;
    height: 300px !important;
    max-width: 100%;
    max-height: 100%;
}

.close9 {
    color: #aaa;
    position:fixed;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 20px; /* Align the close button visually */
    margin-left: 20px;
}

.close9:hover,
.close9:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

/* Full-Screen Popup6969 */
.popup6969 {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    justify-content: center;
    align-items: center;
}

/* Popup6969 Content */
.popup6969-content {
    background: white;
    padding: 20px;
    width: 100%;
    max-height: 100%;
    overflow-y: auto;
    text-align: center;
    border-radius: 10px;
}

/* Close Button */
.close6969 {
    position: absolute;
    z-index:1000000000000000000;
    top: 10px;
    left: 20px;
    font-size: 30px;
    cursor: pointer;
}

/* Upload Button */
#uploadButton6969 {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 10px;
    border: none;
    cursor: pointer;
}

/* Invoice6969 List */
.invoice6969-list {
    margin-top: 20px;
}

/* Invoice6969 Item */
.invoice6969-item {
    padding: 10px;
    border-bottom: 1px solid #ccc;
}

.aspect-ratio-9-16 {
    width: 50px;
    height: 88.89px;
    object-fit: cover;
}

        .aspect-ratio-9-1669 {
            width: 50px;
            height: auto;
            cursor: pointer;
        }
        .loading-text69 {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            padding: 20px;
        }

        #notepad-container751 {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #notepad-list751 {
            display: none;
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .notepad-item751 {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            color: black;  /* Ensure black text */
            text-align: left;
        }
        .notepad-item751:hover {
            background: #f1f1f1;
        }

        /* Popup Styles */
        #notepad-popup751 {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .popup-overlay751 {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        #notepad-text751 {
            width: 100%;
            height: 200px;
            overflow-y: auto;
            resize: none;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        .btn751 {
            display: block;
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-save751 {
            background: green;
            color: white;
        }
        .btn-close751 {
            background: red;
            color: white;
        }
        </style>     
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
<!-- Include jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Include jsPDF autoTable plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
     
        <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>   
    <script>
        function deleteProduct() {
    const productId = document.getElementById("edit-id").value;
    

    if (confirm("Are you sure you want to delete this product?")) {
        fetch('/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: productId })
        })
        .then(response => {
            if (response.ok) {
                alert("Product deleted successfully!");
                location.reload(); // Reload the page to reflect the changes
            } else {
                alert("Failed to delete the product.");
            }
        })
        .catch(error => console.error("Error:", error));
    }
}

        function openModal() {
            document.getElementById("productModal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("productModal").style.display = "none";
            document.getElementById("chatPopup").style.display = "none";
        }
        function openModal2() {
            document.getElementById("productModal2").style.display = "flex";
        }

        function closeModal2() {
            document.getElementById("productModal2").style.display = "none";
        }

        function openEditModal(id, name, category, costPrice, sellingPrice, quantity, supplier, expiry, image) {
    document.getElementById("editModal").style.display = "flex";
    document.getElementById("edit-id").value = id;
    document.getElementById("edit-name").value = name;
    document.getElementById("edit-category").value = category;
    document.getElementById("edit-cost-price").value = costPrice;
    document.getElementById("edit-selling-price").value = sellingPrice;
    document.getElementById("edit-quantity").value = quantity;
    document.getElementById("edit-supplier").value = supplier;
    document.getElementById("edit-expiry").value = expiry;

    // Set current image preview
    let imagePreview = document.getElementById("edit-image-preview");
    if (image) {
        imagePreview.src = `/uploads/${image}`;
        imagePreview.style.display = "block";
    } else {
        imagePreview.style.display = "none";
    }
}


        function closeEditModal() {
            document.getElementById("editModal").style.display = "none";
        }
    </script>
    <script>
        // Function to get the total products based on the highest product ID
function calculateTotalProducts() {
    const productList = document.querySelectorAll('#product-list li');
    let lastProductId = 0;

    // Loop through the product list to find the highest ID
    productList.forEach(product => {
        const productId = parseInt(product.id.split('-')[1]); // Extracts the ID number from product-1
        if (productId > lastProductId) {
            lastProductId = productId;
        }
    });

    return lastProductId;
}

// Function to update the total product count in the header
function updateProductCount() {
    const totalProducts = calculateTotalProducts();
    document.getElementById('product-count').textContent = totalProducts;
}

// Call the function to update the count
updateProductCount();
        // Function to toggle the visibility of the product table


// Ensure that all tables are visible when the page loads
window.onload = function() {
    var tables = document.querySelectorAll('.product-table');
    tables.forEach(function(table) {
        table.style.display = "block";  // Set all tables to be visible on load
    });
};

        // Function to display the popup with the clicked image
        function showPopup(imageSrc) {
            const popup = document.getElementById("imagePopup");
            const popupImage = document.getElementById("popupImage");
            popup.style.display = "flex"; // Show the popup
            popupImage.src = imageSrc; // Set the image source to the clicked image
        }
    
        // Function to close the popup when the close button is clicked
        function closePopup2() {
            const popup = document.getElementById("imagePopup");
            popup.style.display = "none"; // Hide the popup
        }
        function searchTable() {
    const input = document.getElementById("searchInput");
    const filter = input.value.toLowerCase();
    const categories = document.querySelectorAll(".category-section69"); // All categories
    let anyCategoryVisible = false; // Flag to track if any category is visible after filtering

    categories.forEach(categoryDiv => {
        const table = categoryDiv.querySelector(".product-table table tbody");
        const rows = table.getElementsByTagName("tr");
        let categoryHasVisibleRows = false;

        // Check each row in the table
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName("td");
            let rowContainsText = false;

            // Check each cell in the row for search text
            for (let j = 0; j < cells.length; j++) {
                if (cells[j].innerText.toLowerCase().indexOf(filter) > -1) {
                    rowContainsText = true;
                    break;
                }
            }

            // Toggle row visibility based on search match
            rows[i].style.display = rowContainsText ? "" : "none";

            // If any row in the category has a match, mark category as visible
            if (rowContainsText) {
                categoryHasVisibleRows = true;
            }
        }

        // Toggle visibility of the entire category based on the presence of matching rows
        if (categoryHasVisibleRows) {
            categoryDiv.style.display = "block"; // Show category
            anyCategoryVisible = true;
        } else {
            categoryDiv.style.display = "none"; // Hide category if no rows match
        }
    });

    // Ensure at least one category is always visible (in case nothing matches)
    if (!anyCategoryVisible) {
        document.getElementById("categories69").style.display = "none"; // Optional: Hide entire container if no results found
    } else {
        document.getElementById("categories69").style.display = "block"; // Show if any result matches
    }
}

    </script>  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let categoryChart, productChart, productLineChart;

function addMainChartClickEvent(chart, productData) {
    chart.canvas.onclick = function(event) {
        const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, false);
        if (points.length) {
            const index = points[0].index;
            const selectedCategory = chart.data.labels[index];
            const categoryProducts = productData[selectedCategory];

            if (categoryProducts) {
                showCategoryDetails(selectedCategory, categoryProducts);
            }
        }
    };
}

function renderProductLineChart(productsData) {
    // Collect all products and their total quantities
    const allProducts = [];
    for (let category in productsData) {
        for (let product in productsData[category]) {
            allProducts.push({
                product: product,
                quantity: productsData[category][product]
            });
        }
    }

    // Sort by quantity in descending order
    allProducts.sort((a, b) => b.quantity - a.quantity);

    // Extract product names and quantities
    const productNames = allProducts.map(item => item.product);
    const productQuantities = allProducts.map(item => item.quantity);

    const lineCtx = document.getElementById('productLineChart').getContext('2d');
    if (productLineChart) productLineChart.destroy();
    productLineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
            labels: productNames,
            datasets: [{
                label: 'Most Ordered Products',
                data: productQuantities,
                borderColor: '#36A2EB', // Blue line
                backgroundColor: 'rgba(54, 162, 235, 0.2)', // Light blue filled area
                fill: true,
                tension: 0.3, // Smooth line curve
                pointRadius: 5, // Bigger points for emphasis
                pointBackgroundColor: '#36A2EB'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw} orders`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: 'white',
                    }
                },
                x: {
                    ticks: {
                        color: 'white',
                        maxRotation: 45, // Rotate labels for readability
                        minRotation: 45
                    }
                }
            }
        }
    });
}

let supplierLineChart;

function renderSupplierLineChart(supplierData) {
    // Extract supplier names and their frequencies
    const supplierNames = Object.keys(supplierData);
    const supplierFrequencies = Object.values(supplierData);

    // Get the canvas context
    const lineCtx = document.getElementById('supplierLineChart').getContext('2d');

    // Destroy previous chart if it exists
    if (supplierLineChart) supplierLineChart.destroy();

    // Create new line chart
    supplierLineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
            labels: supplierNames,
            datasets: [{
                label: 'Supplies Frequency',
                data: supplierFrequencies,
                borderColor: '#E74C3C', // Red line
                backgroundColor: 'rgba(231, 76, 60, 0.2)', // Light red fill
                fill: true,
                tension: 0.4, // Smooth curves
                pointRadius: 5,
                pointBackgroundColor: '#E74C3C',
                pointBorderColor: 'white',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw} supplies`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: 'white' }
                },
                x: {
                    ticks: {
                        color: 'white',
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

function showCategoryDetails(category, products) {
    document.getElementById('categoryDetails').style.display = "block";
    document.querySelector('#categoryDetails h4').textContent = `Details for: ${category}`;

    const productLabels = Object.keys(products);
    const productValues = Object.values(products);

    const ctx = document.getElementById('categoryPieChart').getContext('2d');
    if (productChart) productChart.destroy();
    productChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: productLabels,
            datasets: [{
                label: 'Product Quantities',
                data: productValues,
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4CAF50', '#AB47BC']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw} units`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: 'white',  // Set Y axis ticks color to white
                    }
                },
                x: {
                    ticks: {
                        color: 'white',  // Set X axis ticks color to white
                    }
                }
            }
        }
    });
}

let supplierChart;

function showReportPopup() {
    document.getElementById('reportModal').style.display = "block";

    // Fetch and render orders data
    fetch('/get-report-data')
        .then(response => response.json())
        .then(data => {
            // Render main bar chart (Orders by Category)
            const categories = Object.keys(data.categories);
            const quantities = Object.values(data.categories);

            const mainCtx = document.getElementById('mainPieChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(mainCtx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Frequency of Sales',
                        data: quantities,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw} orders`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'white',  // Set Y axis ticks color to white
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white',  // Set X axis ticks color to white
                            }
                        }
                    }
                }
            });

            addMainChartClickEvent(categoryChart, data.products);
            renderProductLineChart(data.products);
        })
        .catch(error => console.error('Error fetching order data:', error));

    // Fetch and render supplier data
fetch('/get_chart_data')
    .then(response => response.json())
    .then(data => {
        const supplierData = data.supplierData;

        // Render bar chart for suppliers
        const supplierCtx = document.getElementById('supplierPieChart').getContext('2d');
        if (supplierChart) supplierChart.destroy();
        supplierChart = new Chart(supplierCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(supplierData),
                datasets: [{
                    label: 'Frequency of Suppliers',
                    data: Object.values(supplierData),
                    backgroundColor: ['#3498DB', '#E74C3C', '#F1C40F', '#9B59B6', '#1ABC9C']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw} products supplied`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: 'white' }
                    },
                    x: {
                        ticks: { color: 'white' }
                    }
                }
            }
        });

        // Render line chart for supplier trends
        renderSupplierLineChart(supplierData);
    })
    .catch(error => console.error('Error fetching supplier data:', error));
}
function closeReportPopup() {
    document.getElementById('reportModal').style.display = "none";
    document.getElementById('categoryDetails').style.display = "none";
}

    
        function closeReportPopup() {
            document.getElementById('reportModal').style.display = "none";
            document.getElementById('categoryDetails').style.display = "none";
        }

        function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: "portrait",
        unit: "pt",
        format: "A4"
    });

    const table = document.getElementById('ordersTable');

    let userOrders = {}; // Object to store orders grouped by username

    const headers = [];
    const rows = table.querySelectorAll("tbody tr");

    // Extract headers, skipping columns: 1st (0), 2nd (1), 5th (4), and last
    const thElements = table.querySelectorAll("thead th");
    thElements.forEach((th, index) => {
        if (index !== 0 && index !== 1 && index !== 4 && index < thElements.length - 1) {
            headers.push(th.innerText);
        }
    });

    // Group rows by username
    rows.forEach(row => {
        if (row.style.display !== "none") {
            const cells = row.querySelectorAll("td");

            // Extract username from the first column
            if (cells.length > 0) {
                const firstColumnText = cells[0].innerText;
                let username = firstColumnText.includes(" | ") ? firstColumnText.split(" | ")[1].trim() : "Unknown";

                // Skip columns: 1st (0), 2nd (1), 5th (4), and last
                const rowData = [];
                cells.forEach((cell, index) => {
                    if (index !== 0 && index !== 1 && index !== 4 && index < cells.length - 1) {
                        rowData.push(cell.innerText);
                    }
                });

                if (!userOrders[username]) {
                    userOrders[username] = [];
                }
                userOrders[username].push(rowData);
            }
        }
    });

    let startY = 20; // Initial Y position

    Object.keys(userOrders).forEach((username, index) => {
        if (index > 0) {
            startY += 20; // Add space between sections
        }

        // Add username heading
        doc.setFontSize(14);
        doc.text(`Client: ${username}`, 20, startY);
        startY += 20; // Move down for the table

        // Generate table for this user
        doc.autoTable({
            head: [headers],
            body: userOrders[username],
            startY: startY,
            theme: 'grid',
            styles: { fontSize: 9, cellPadding: 4, halign: 'center', valign: 'middle' },
            columnStyles: { 0: { cellWidth: 'auto' } }, 
            margin: { left: 5, right: 5 },
            tableLineWidth: 0.75,
            tableWidth: 'auto',
        });

        startY = doc.lastAutoTable.finalY + 10; // Move to next position for next user
    });

    doc.save('Orders.pdf');
}




function generatePDF2() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: "portrait",
        unit: "pt",
        format: "A4"
    });


    // Get the table element
    const table = document.getElementById('historyTable');

    // Use jsPDF's autoTable plugin to convert the HTML table into a PDF
    doc.autoTable({
        head: [headers],
        body: data,
        startY: 20,
        theme: 'grid',
        styles: { fontSize: 9, cellPadding: 4 }, // Set font size to 14
        columnStyles: { 0: { cellWidth: 'auto' } }, 
        margin: { left: 5, right: 5 }, // Reduce margins
        tableWidth: 'auto',
    });

    // Save the PDF with a name (optional)
    doc.save('OrderHistory.pdf');
}

function clearOrders() {
    // Send a request to the server to clear the orders.txt file
    fetch('/clearorders', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Orders have been cleared.');
            // Optionally, you can clear the table content on the front end as well
            document.getElementById('ordersTableBody').innerHTML = '';
        } else {
            alert('Failed to clear orders.');
        }
    })
    .catch(error => {
        console.error('Error clearing orders:', error);
        alert('An error occurred while clearing orders.');
    });
}

function clearnotify() {
    // Send a request to the server to clear the orders.txt file
    fetch('/clearnotify', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Notifications have been cleared.');
            // Optionally, you can clear the table content on the front end as well
            document.getElementById('notifyMessages').innerHTML = '';
        } else {
            alert('Failed to clear notifications.');
        }
    })
    .catch(error => {
        console.error('Error clearing notifications:', error);
        alert('An error occurred while clearing notifications.');
    });
}

    </script>       
</head>
<body>
    <!-- Login Popup -->
    <div id="loginPopup">
        <center><div class="popup-content1">
            <h2 style="color:#45a049;">Welcome to Ingredients</h2>
            <input style="margin-top:70px;" type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button style="margin-top:70px;" onclick="login()">Login</button>
            <p id="loginError" style="color: red; display: none;">Invalid credentials. Please try again.</p>
        </div></center>
    </div>

    <div id="pageContent">
        <!-- Fixed header -->
        <div class="header">
            <h1>Product Management
                <span onclick="openModal2()" class="total-products">Total Products: <span id="product-count">{{ total_products }}</span></span>
                <span style="margin-left:15px;">
                    <select id="category-select" onchange="filterCategory()">
                        <option value="">--All Categories--</option>
                    </select>                                       
                </span>
                <span>
                    <input 
                            type="text" 
                            id="searchInput" 
                            onkeyup="searchTable()" 
                            placeholder="Search..." 
                            style="margin-left: 15px; margin-top:0px; text-align: center; width: 15%;font-size: 16px; box-sizing: border-box; background-color:#4CAF50; color: white; border: solid 2px rgba(255, 255, 255, 0.774);">
                </span>
                
                <div style="margin-left:15px; margin-top:5px;">
                    <a href="{{ url_for('logoutindex') }}">
                        <img style="width:5%;" src="static/logout.png" alt="logout">
                    </a>
                    <img id="notificationIcon" style="width:35px; margin-left:15px; cursor:pointer;" src="static/notification.png" alt="Notify">
                    <div id="notifyPopup" class="popup1">
                        <button onclick="clearnotify()" style="top: 8px; position: absolute; left:8px; padding: 2.5px 5px; background-color: rgba(255, 255, 255, 0.651); border-radius: 10px;">Clear Notifications</button>
                        <span class="close-btn" onclick="closePopup()">&times;</span>
                        <div class="popup-content">
                            <!-- Notify Messages Section -->
                            <h2 style="color: #4CAF50;">Notification Messages</h2>
                            <div class="popup1-scroll" id="notifyMessages"></div>
                    
                            <!-- Out of Stock Products Section -->
                            <h2 style="color: #4CAF50;">Out of Stock Products</h2>
                            <div class="popup2-scroll" id="outOfStockMessages"></div>
                        </div>
                    </div>
                    <img style="width:40px; margin-left:15px;" src="static/order.png" alt="Orders" onclick="fetchOrders()">
                    <img style="width:40px; margin-left:15px;" src="static/report.png" alt="Report" onclick="showReportPopup()">
                    <img style="width:40px; margin-left:15px;" id="notepad-image751" src="static/notes.png" alt="Notepad" onclick="showNotepadList751()">
                    <div id="reportModal" class="modal9" style="display:none;">
                        <span class="close9" onclick="closeReportPopup()">&times;</span>
                        <div class="modal9-content">
                            <div style="display: flex; justify-content: space-evenly; flex-wrap: wrap; margin-top: 50px;">
                                <!-- Bar Chart -->
                                <div>
                                    <canvas id="mainPieChart"></canvas>
                                </div>
                                <!-- Line Chart -->
                                <div>
                                    <canvas id="productLineChart"></canvas>
                                </div>
                            </div>
                            <div id="categoryDetails" style="margin-top: 20px; display:none;">
                                <h4 style="color:#4d4d4d">Category Details</h3>
                                <canvas id="categoryPieChart" style="width:100%; max-width:600px;"></canvas>
                            </div>
                            <div id="categoryDetails" style="margin-top: 20px; display:none;">
                                <h4 style="color:#4d4d4d">Category Details</h4>
                                <canvas id="categoryPieChart"></canvas>
                            </div>
                            <div style="display: flex; justify-content: space-evenly; flex-wrap: wrap; margin-top: 50px;">
                                <!-- Bar Chart -->
                                <div>
                                    <canvas id="supplierPieChart"></canvas>
                                </div>
                                <!-- Line Chart -->
                                <div>
                                    <canvas id="supplierLineChart"></canvas>
                                </div>
                            </div>
                            <div style="margin-top: 50px;"><canvas id="ordersChart69"></canvas> <!-- Chart Container --></div>
                            

                            <script>
                                // Get order data from Flask (Passed via Jinja)
                                const topClients = {{ top_clients | tojson }};
                        
                                const clients = topClients.map(item => item.client);  // Client names
                                const orders = topClients.map(item => item.orders);  // Order counts
                        
                                // Create the bar chart
                                const ctx = document.getElementById('ordersChart69').getContext('2d');
                                new Chart(ctx, {
                                    type: 'bar',
                                    data: {
                                        labels: clients,
                                        datasets: [{
                                            label: 'Total Orders',
                                            data: orders,
                                            backgroundColor: 'skyblue',
                                            borderColor: 'blue',
                                            borderWidth: 1,
                                            barPercentage: 0.5, // Reduce bar width
                                            categoryPercentage: 0.5 // Reduce space between bars
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                ticks: {
                                                    font: {
                                                        size: 14 // Increase Y-axis text size
                                                    }
                                                }
                                            },
                                            x: {
                                                ticks: {
                                                    font: {
                                                        size: 14 // Increase X-axis text size
                                                    }
                                                }
                                            }
                                        },
                                        plugins: {
                                            legend: {
                                                labels: {
                                                    font: {
                                                        size: 16 // Increase legend text size
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                            </script>
                        </div>

                    </div>
                    <div id="invoicePopup6969" class="popup6969">
                        <div class="popup6969-content" style="background-color:#212121">
                            <span class="close6969" onclick="closePopup6969()">&times;</span>
                            <h2>Invoices</h2>
                            
                            <!-- Upload Button -->
                            <button id="uploadButton6969" onclick="document.getElementById('uploadInput6969').click();">Upload Invoice</button>
                    
                            <!-- Hidden File Input for PDF -->
                            <input type="file" id="uploadInput6969" style="display: none;" accept="application/pdf" onchange="uploadPDF()" />
                    
                            <!-- Invoice List -->
                            <div id="invoiceList6969" class="invoice6969-list"></div>
                        </div>
                    </div>
                    
                    <!-- Clickable Image to Open Popup6969 -->
                    <img style="width:3.7%; margin-left:15px; cursor: pointer;" src="static/file.png" alt="Notify" onclick="openPopup6969()">
                    
                    <!-- Delete Confirmation Popup -->
                    <div id="deleteConfirmationPopup" class="popup6969">
                        <div class="popup6969-content">
                            <span class="close6969" onclick="closeDeleteConfirmationPopup()">&times;</span>
                            <h3>Are you sure you want to delete this invoice?</h3>
                            <button id="confirmDeleteButton" onclick="deleteInvoice()">Delete</button>
                            <button onclick="closeDeleteConfirmationPopup()">Cancel</button>
                        </div>
                    </div>
                    
                    <script>
                        let invoiceToDelete = '';  // Track which invoice is being deleted
                    
                        // Function to Open the Popup6969
                        function openPopup6969() {
                            document.getElementById("invoicePopup6969").style.display = "block";
                            fetchInvoices6969();  // Load invoices when opened
                        }
                    
                        // Function to Close the Popup6969
                        function closePopup6969() {
                            document.getElementById("invoicePopup6969").style.display = "none";
                        }
                    
                        // Function to Open the Delete Confirmation Popup
                        function openDeleteConfirmationPopup(invoiceName) {
                            invoiceToDelete = invoiceName;  // Set the invoice to be deleted
                            document.getElementById("deleteConfirmationPopup").style.display = "block";
                        }
                    
                        // Function to Close the Delete Confirmation Popup
                        function closeDeleteConfirmationPopup() {
                            document.getElementById("deleteConfirmationPopup").style.display = "none";
                        }
                    
                        // Function to Fetch PDF Invoices from Server
                        function fetchInvoices6969() {
                            fetch('/get_invoices')
                                .then(response => response.json())
                                .then(data => {
                                    const invoiceList = document.getElementById("invoiceList6969");
                                    invoiceList.innerHTML = "";  // Clear previous entries
                    
                                    if (data.invoices.length === 0) {
                                        invoiceList.innerHTML = "<p>No invoices available.</p>";
                                        return;
                                    }
                    
                                    data.invoices.forEach(pdf => {
                                        const pdfElement = document.createElement("div");
                                        pdfElement.className = "invoice6969-item";
                                        pdfElement.innerHTML = `
                                            <button onclick="downloadInvoice('${pdf}')">
                                                <i class="fas fa-folder"></i> ${pdf}
                                            </button>
                                            <button onclick="openDeleteConfirmationPopup('${pdf}')">Delete</button>
                                        `;
                                        invoiceList.appendChild(pdfElement);
                                    });
                                })
                                .catch(error => console.error("Error fetching invoices:", error));
                        }
                    
                        function downloadInvoice(invoiceName) {
                            // Creating a dynamic download link
                            const url = `/download_invoice/${invoiceName}`;
                            
                            // Creating an anchor element and triggering a download
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = invoiceName; // Optionally specify the file name
                            a.click(); // Trigger the download
                        }
                    
                        function uploadPDF() {
                            const fileInput = document.getElementById('uploadInput6969');
                            const formData = new FormData();
                            formData.append("pdf", fileInput.files[0]);
                    
                            // Send the file to Flask backend
                            fetch('/upload_invoice', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Invoice uploaded successfully!');
                                } else {
                                    alert('Failed to upload invoice.');
                                }
                                window.location.reload();
                            })
                            .catch(error => {
                                console.error('Error uploading file:', error);
                            });
                        }
                    
                        // Function to delete the invoice
                        function deleteInvoice() {
                            fetch(`/delete_invoice/${invoiceToDelete}`, { method: 'DELETE' })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        alert('Invoice deleted successfully!');
                                        window.location.reload();  // Reload the page to reflect changes
                                    } else {
                                        alert('Failed to delete invoice.');
                                    }
                                    closeDeleteConfirmationPopup();  // Close the confirmation popup
                                })
                                .catch(error => {
                                    console.error('Error deleting invoice:', error);
                                    alert('An error occurred while deleting the invoice.');
                                });
                        }
                    </script>
                     <div id="notepad-container751">
                        <div id="notepad-list751">
                            <h3 style="color:#242424; text-align: center;">Select a Wishlist</h3>
                            {% for notepad in notepads %}
                                <div class="notepad-item751" onclick="loadNotepad751('{{ notepad }}')">
                                    📄 {{ notepad[:-4] }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                
                    <!-- Popup Overlay -->
                    <div class="popup-overlay751" id="popup-overlay751" onclick="closeNotepad751()"></div>
                
                    <!-- Notepad Popup -->
                    <div id="notepad-popup751">
                        <h3 id="notepad-title751" style="color:#242424">Wishlist</h3>
                        <textarea id="notepad-text751"></textarea>
                        <button class="btn751 btn-save751" onclick="saveNotepad751()">Save Changes</button>
                        <button class="btn751 btn-close751" onclick="closeNotepad751()">Close</button>
                    </div>
                
                    <script>
                        let currentFilename = "";
                
                        function showNotepadList751() {
                            let list = document.getElementById("notepad-list751");
                            list.style.display = (list.style.display === "block") ? "none" : "block";
                        }
                
                        function loadNotepad751(filename) {
                            fetch(`/get-notepad?filename=${filename}`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        currentFilename = filename;
                                        document.getElementById("notepad-title751").innerText = `Editing: ${filename.replace('.txt', '')}`;
                                        document.getElementById("notepad-text751").value = data.content || "";
                                        document.getElementById("notepad-popup751").style.display = "block";
                                        document.getElementById("popup-overlay751").style.display = "block";
                                    } else {
                                        alert("Error: " + data.message);
                                    }
                                });
                        }
                
                        function saveNotepad751() {
                            const content = document.getElementById("notepad-text751").value;
                
                            fetch('/save-notepad', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ filename: currentFilename, content })
                            })
                            .then(response => response.json())
                            .then(result => {
                                if (result.success) {
                                    alert("Wishlist saved successfully!");
                                    closeNotepad751();
                                } else {
                                    alert("Error: " + result.message);
                                }
                            });
                        }
                
                        function closeNotepad751() {
                            document.getElementById("notepad-popup751").style.display = "none";
                            document.getElementById("popup-overlay751").style.display = "none";
                        }
                    </script>

    <!-- Orders Popup -->
    <div id="ordersPopup" class="popup3">
        <div class="popup3-content">
            <span class="close6" onclick="closePopup1('ordersPopup')">&times;</span>
            <button onclick="clearOrders()" style="margin-top: 20px; margin-left:20px; padding: 5px 10px;">Clear Orders</button>
            <h2 style="text-align: center;">Order History</h2>
            
            <label style="margin-left: 20px;" for="userFilter">Filter by Username:</label>
            <select id="userFilter" onchange="filterOrders()">
                <option value="all">All Users</option>
            </select>
    
            <label style="margin-left: 20px;" for="dateFilter">Filter by Date:</label>
            <select id="dateFilter" onchange="filterOrders()">
                <option value="all">All Dates</option>
            </select>

            <!-- Custom Date Range Filter -->
            <label style="margin-left: 20px;" for="fromDate">From:</label>
            <input type="date" id="fromDate" onchange="formatAndFilterOrders()">

            <label style="margin-left: 10px;" for="toDate">To:</label>
            <input type="date" id="toDate" onchange="formatAndFilterOrders()">

    
            <button onclick="generatePDF()">Download PDF</button> 
            <button onclick="openHistoryPopup()">HISTORY</button> 
    
            <div id="orderMessages">
                <table id="ordersTable" class="orders-table">
                    <thead>
                        <tr>
                            <th>Time & Username</th>
                            <th>Product ID</th>
                            <th>Order Quantity</th>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Messages</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="historyPopup" class="popup3">
        <div class="popup3-content">
            <span class="close6" onclick="closePopup1('historyPopup')">&times;</span>
            <h2 style="text-align: center;">Order History</h2>
            <button style="margin-left:10px;" onclick="generatePDF2()">Download PDF</button> 
    
            <div id="historyMessages">
                <table id="historyTable" class="orders-table">
                    <thead>
                        <tr>
                            <th>Time & Username</th>
                            <th>Product ID</th>
                            <th>Order Quantity</th>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Messages</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>    
                
                </div>
            </h1>
            <button onclick="openModal()" class="add-button">+ Add Product</button>
        </div>



        <script>
function openHistoryPopup() {
    fetch('/get-order-history')  // Use new route
        .then(response => response.json())
        .then(data => {
            const historyTableBody = document.getElementById('historyTableBody');
            historyTableBody.innerHTML = '';  // Clear previous content

            data.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.username}</td>
                    <td>${order.productId}</td>
                    <td>${order.quantity}</td>
                    <td>${order.productName}</td>
                    <td>${order.category}</td>
                    <td>${order.message}</td>
                `;
                historyTableBody.appendChild(row);
            });

            // Show the history popup
            document.getElementById('historyPopup').style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching order history:', error);
            alert('Failed to load order history.');
        });
}

            
            function fetchOrders() {
    fetch('/get-orders')
        .then(response => response.json())
        .then(data => {
            const userFilter = document.getElementById('userFilter');
            const dateFilter = document.getElementById('dateFilter');
            const ordersTableBody = document.getElementById('ordersTableBody');

            userFilter.innerHTML = '<option value="all">All Users</option>';
            dateFilter.innerHTML = '<option value="all">All Dates</option>';
            ordersTableBody.innerHTML = '';

            const reversedData = data.reverse();
            const usernames = new Set();
            const dates = new Set();

            reversedData.forEach(order => {
                usernames.add(order.filtername);
                dates.add(order.date);

                const row = document.createElement('tr');
                row.className = 'order-row';
                row.setAttribute('data-filtername', order.filtername);
                row.setAttribute('data-date', order.date);

                row.innerHTML = `
                    <td>${order.username}</td>
                    <td>${order.productId}</td>
                    <td>${order.quantity}</td>
                    <td>${order.productName}</td>
                    <td>${order.category}</td>
                    <td>${order.message}</td>
                    <td><button class="delete-button" onclick="deleteOrder('${order.username}', '${order.productId}', '${order.quantity}', '${order.productName}', '${order.category}', '${order.message}')">Delete</button></td>
                `;
                ordersTableBody.appendChild(row);
            });

            usernames.forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                userFilter.appendChild(option);
            });

            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                dateFilter.appendChild(option);
            });

            document.getElementById('ordersPopup').style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching orders:', error);
            alert('Failed to load orders.');
        });
}

function deleteOrder(username, productId, quantity, productName, category, message) {
    const orderString = `${username},${productId},${quantity},${productName},${category},${message}`;

    fetch('/delete-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ order: orderString })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Order deleted successfully!');
            fetchOrders(); // Reload orders after deletion
        } else {
            alert('Error deleting order: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete order.');
    });
}
function formatAndFilterOrders() {
    const fromDate = document.getElementById('fromDate').value; // YYYY-MM-DD
    const toDate = document.getElementById('toDate').value; // YYYY-MM-DD

    filterOrders(fromDate, toDate);
}

function filterOrders(fromDate, toDate) {
    const userValue = document.getElementById('userFilter').value;
    const dateValue = document.getElementById('dateFilter').value;
    const rows = document.querySelectorAll('#ordersTableBody .order-row');

    rows.forEach(row => {
        const orderDate = row.getAttribute('data-date'); // Order date is already in YYYY-MM-DD

        let matchesDateRange = true;
        if (fromDate && toDate) {
            matchesDateRange = orderDate >= fromDate && orderDate <= toDate;
        }

        // Check other filters
        const matchesUser = userValue === 'all' || row.getAttribute('data-filtername') === userValue;
        const matchesDate = dateValue === 'all' || orderDate === dateValue;

        row.style.display = matchesUser && matchesDate && matchesDateRange ? '' : 'none';
    });
}



function closePopup1(popupId) {
    document.getElementById(popupId).style.display = 'none';
}

        </script>





        <script>
            document.getElementById("notificationIcon").addEventListener("click", async () => {    
        try {
            // Fetch notify messages
            const notifyResponse = await fetch('/get-notify-messages');
            const notifyData = await notifyResponse.json();
            document.getElementById("notifyMessages").innerHTML = notifyData.messages.length > 0
                ? `<ul>${notifyData.messages.reverse().map(msg => `<li style="font-size:2vh; margin-bottom:8px; border: solid 1px #4CAF50; border-radius:5px; color:#e2dfdf;">${msg}</li>`).join("")}</ul>`
                : "<p>No notifications available.</p>";
    
            // Fetch out-of-stock products
            const outOfStockResponse = await fetch('/get-out-of-stock-products');
            const outOfStockData = await outOfStockResponse.json();

            if (outOfStockData.products.length > 0) {
                // Create a table for the out-of-stock products
                const tableHTML = `
                    <table class="out-of-stock-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${outOfStockData.products.map(prod => `
                                <tr>
                                    <td>${prod.id}</td>
                                    <td>${prod.name}</td>
                                    <td>${prod.category}</td>
                                </tr>
                            `).join("")}
                        </tbody>
                    </table>`;
                document.getElementById("outOfStockMessages").innerHTML = tableHTML;
            } else {
                document.getElementById("outOfStockMessages").innerHTML = "<p>All products are in stock.</p>";
            }

            // Show the popup
            document.getElementById("notifyPopup").style.display = "flex";
        } catch (error) {
            console.error("Error fetching notifications:", error);
            alert("An error occurred while loading notifications.");
        }
    });

    function closePopup() {
        document.getElementById("notifyPopup").style.display = "none";
    }

            </script>          

        <!-- Modal for the add product form -->
        <div id="productModal" class="modal">
            <div class="modal-content">
                <button onclick="closeModal()" class="close-button">&times; Close</button>
                <h2>Add Product</h2>
                <form method="POST" action="/007PageLoginAdminThe007" enctype="multipart/form-data" class="form-container">
                    <!-- Product Name -->
<!-- Product Name -->
<label for="product-name">Product Name:</label>
<input list="product-list" name="name" id="product-name">
<datalist id="product-list">
    {% for category, items in products.items() %}
        {% for product in items %}
            <option value="{{ product[1] }}"></option>  <!-- Product Name from products.txt -->
        {% endfor %}
    {% endfor %}
</datalist>

<!-- Category -->
<label for="category2">Category:</label>
<input list="category-list2" name="category2" id="category2" required oninput="fetchCategories()">
<datalist id="category-list2"></datalist>

<script>
    async function fetchCategories() {
        const input = document.getElementById("category2").value;
        const datalist = document.getElementById("category-list2");

        if (input.length < 1) return; // Don't fetch for empty input

        try {
            const response = await fetch(`/get_categories2?query=${encodeURIComponent(input)}`);
            const categories = await response.json();
            
            datalist.innerHTML = ""; // Clear previous options
            
            categories.forEach(category => {
                let option = document.createElement("option");
                option.value = category;
                datalist.appendChild(option);
            });
        } catch (error) {
            console.error("Error fetching categories:", error);
        }
    }
</script>



<!-- Supplier -->
<label for="supplier">Supplier:</label>
<input list="supplier-list" name="supplier" id="supplier" required>
<datalist id="supplier-list">
    {% set unique_suppliers = [] %}
    {% for category, items in products.items() %}
        {% for product in items %}
            {% if product[7] not in unique_suppliers %}
                <option value="{{ product[7] }}"></option>  <!-- Unique Suppliers -->
                {% set _ = unique_suppliers.append(product[7]) %}
            {% endif %}
        {% endfor %}
    {% endfor %}
</datalist>
                    <label>Cost Price: <input type="number" name="cost_price" step="0.01" required></label>
                    <label>Selling Price: <input type="number" name="selling_price" step="0.01" required></label>
                    <label>Quantity: <input type="number" name="quantity" required></label>
                    <label>Expiry: <input type="text" name="expiry" required oninput="cleanInput(this)"></label>
                    <div class="form-group">
                        <label for="image">Product Image</label>
                        <input type="file" name="image" id="image" class="form-control" accept="image/*">
                    </div>
                    <button type="submit" class="add-button">Add Product</button>
                </form>            
            </div>
        </div>
        <script>
            function cleanInput(input) {
                // Remove leading/trailing spaces
                input.value = input.value.trim();
                
                // Remove double spaces and replace with a single space
                input.value = input.value.replace(/\s{2,}/g, ' ');
            }
        </script>

        <div id="productModal2" class="modal">
            <div class="modal-content">
                <button onclick="closeModal2()" class="close-button">&times; Close</button>
                    <div>
                        <h2 style="margin-top:5px; text-align: left;"><span>Total Products: <span id="product-count">{{ total_products }}</span></span></h2>
                        <ul class="scroll-bruh">
                            {% for category, count in category_counts.items() %}
                                <li>{{ category }}: {{ count }} products</li>
                            {% endfor %}
                        </ul>
                    </div>        
            </div>
        </div>

        <!-- Modal for editing product details -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <button onclick="closeEditModal()" class="close-button">&times; Close</button>
                <h2>Edit Product</h2>
                <form method="POST" action="/edit" enctype="multipart/form-data" class="form-container">
                    <input type="hidden" name="id" id="edit-id">
                    <label>Product Name: <input type="text" name="name" id="edit-name" required></label>
                    <label>Category: <input type="text" name="category" id="edit-category" required></label>
                    <label>Supplier: <input type="text" name="supplier" id="edit-supplier" required></label>
                    <label>Cost Price: <input step="0.01" type="number" name="cost_price" id="edit-cost-price" required></label>
                    <label>Selling Price: <input step="0.01" type="number" name="selling_price" id="edit-selling-price" required></label>
                    <label>Quantity: <input type="number" name="quantity" id="edit-quantity" required></label>
                    <label>Expiry: <input type="text" name="expiry" id="edit-expiry" required></label>
        
                    <!-- Image Preview -->
                    <div class="form-group">
                        <label for="edit-image">Product Image</label>
                        <img id="edit-image-preview" src="" alt="Current Image" class="edit-image-preview">
                        <input type="file" name="image" id="edit-image" class="form-control" accept="image/*">
                    </div>
        
                    <button type="submit" class="add-button">Save Changes</button>
                </form>
                <button class="delete-button" onclick="deleteProduct()">Delete Product</button>
            </div>
        </div>
<!-- Product Categories and Tables -->
<div id="categories69"></div>

    <!-- Loading Indicator -->
    <div id="loading69" class="loading-text69" style="display: none;">Loading more products...</div>
<script>
    let start = 0;
    const limit = 5;
    let loading = false;
    let allLoaded = false; // Stop fetching if no more products
    
    // Function to filter categories dynamically
    function filterCategory() {
    let selectedCategory = document.getElementById("category-select").value;
    let allCategories = document.querySelectorAll(".category-section69");

    allCategories.forEach(categoryDiv => {
        if (selectedCategory === "" || categoryDiv.id === `category-${selectedCategory}`) {
            categoryDiv.style.display = "block"; // Show selected category
        } else {
            categoryDiv.style.display = "none"; // Hide other categories
        }
    });

    // ✅ Ensure selected category is loaded
    ensureCategoryIsLoaded(selectedCategory);
}

async function ensureCategoryIsLoaded(selectedCategory) {
    if (selectedCategory === "") return; // If "All Categories" is selected, do nothing

    while (!document.getElementById(`category-${selectedCategory}`) && !allLoaded) {
        await loadMoreProducts69(); // Load more products until the category is available
        await new Promise(resolve => setTimeout(resolve, 500)); // Small delay to allow DOM update
    }

    // ✅ Scroll to the selected category if it's not in view
    let categoryDiv = document.getElementById(`category-${selectedCategory}`);
}

    
    // ✅ Load all categories from the backend
    async function loadCategories() {
        let response = await fetch('/get_categories');  // Fetch all categories
        let data = await response.json();
        let categorySelect = document.getElementById("category-select");
    
        // Clear existing categories except "--All Categories--"
        categorySelect.innerHTML = `<option value="">--All Categories--</option>`;
    
        // Populate category dropdown with all categories from backend
        data.categories.forEach(category => {
            let option = document.createElement("option");
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
    }
    
    // ✅ Fetch more products dynamically
    async function loadMoreProducts69() {
        if (loading || allLoaded) return;
        loading = true;
        document.getElementById("loading69").style.display = "block";
    
        let response = await fetch(`/007PageLoginAdminThe007?load_more=true&start=${start}`);
        let data = await response.json();
    
        let newProducts = data.products;
        if (Object.keys(newProducts).length === 0) {
            allLoaded = true;
            document.getElementById("loading69").innerText = "No more products.";
            return;
        }
    
        renderProducts69(newProducts);
        start += limit;
        loading = false;
        document.getElementById("loading69").style.display = "none";
    
        if (!data.has_more) {
            allLoaded = true;
            document.getElementById("loading69").innerText = "No more products.";
        }
    }
    
    // ✅ Populate category dropdown only if new categories are found
    function populateCategoryDropdown(products) {
        let categorySelect = document.getElementById("category-select");
        let existingCategories = new Set([...categorySelect.options].map(option => option.value));
    
        for (let category in products) {
            if (!existingCategories.has(category)) {
                let option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            }
        }
    }
    
    // ✅ Render products into categories dynamically
    function renderProducts69(products) {
        let container = document.getElementById("categories69");
    
        for (let category in products) {
            if (!document.getElementById(`category-${category}`)) {
                let categoryDiv = document.createElement("div");
                categoryDiv.className = "category-section69";
                categoryDiv.id = `category-${category}`;
                categoryDiv.innerHTML = `
                    <h2 class="prod-headings" onclick="toggleTableVisibility('table-${category}')">${category}</h2>
                    <div class="product-table">
                        <table id="table-${category}" class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Supplier</th>
                                    <th>Cost Price</th>
                                    <th>Selling Price</th>
                                    <th>Quantity</th>
                                    <th>Expiry</th>
                                    <th>Image</th>
                                    <th>Edit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products[category].map(product => `
                                    <tr>
                                        <td>${product[0]}</td>
                                        <td>${product[1]}</td>
                                        <td>${product[2]}</td>
                                        <td>${product[7]}</td>
                                        <td>${parseFloat(product[3]).toFixed(2)}</td>
                                        <td>${parseFloat(product[4]).toFixed(2)}</td>
                                        <td>${product[5]}</td>
                                        <td>${product[8]}</td>
                                        <td>
                                            ${product[6] ? `<img src="/uploads/${product[6]}" class="aspect-ratio-9-1669" onclick="showPopup('/uploads/${product[6]}')">` : "No Image"}
                                        </td>
                                        <td>
                                            <button type="button" class="edit-button" onclick="openEditModal('${product[0]}', '${product[1]}', '${product[2]}', '${product[3]}', '${product[4]}', '${product[5]}', '${product[7]}', '${product[8]}')">
                                                📝
                                            </button>
                                        </td>
                                    </tr>
                                `).join("")}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(categoryDiv);
            }
        }
    }
    
    // ✅ Toggle table visibility
    function toggleTableVisibility(tableId) {
        let table = document.getElementById(tableId);
        if (table) {
            table.style.display = table.style.display === "none" ? "table" : "none";
        }
    }
    
    // ✅ Load more products when scrolling
    window.addEventListener("scroll", function () {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
            loadMoreProducts69();
        }
    });
    
    // ✅ Load categories and products on page load
    window.onload = function() {
        loadCategories();  // Ensure all categories load first
        loadMoreProducts69();  // Start lazy-loading products
    };
    

    </script>    
    

    <!-- JavaScript to Filter and Show/Hide Categories -->
    <script>

        
    </script>
        <div id="imagePopup" class="popup">
            <span class="close-button" onclick="closePopup2()">&times;</span>
            <img id="popupImage" src="" alt="Product Image">
        </div>

        <script>
    
            // Function to handle login
            // Handle Login Popup Display
            document.addEventListener("DOMContentLoaded", function () {
    const showLoginPopup = {{ show_login_popup | default(false) | tojson }};
    const loginPopup = document.getElementById("loginPopup");

    if (showLoginPopup) {
        // Show login popup if required
        loginPopup.style.display = "flex";  
    } else {
        // Hide login popup initially
        loginPopup.style.display = "none";
    }
});

// Login Function
async function login() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    const loginError = document.getElementById("loginError");

    if (username === "warehouse" && password === "warehouse1") {
        try {
            const response = await fetch("/validate-login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                // If login is successful, update session and reload the page
                localStorage.setItem("isLoggedIn", "true"); // Store login status
                document.getElementById("loginPopup").style.display = "none";
                document.getElementById("pageContent").classList.remove("hidden");
                location.reload(); 
            } else {
                loginError.style.display = "block";
                loginError.textContent = "Login failed. Please try again.";
            }
        } catch (error) {
            console.error("Login failed:", error);
            loginError.style.display = "block";
            loginError.textContent = "An error occurred. Please try again.";
        }
    } else {
        // Show error message for incorrect credentials
        loginError.style.display = "block";
        loginError.textContent = "Wrong username or password.";
    }
}
        </script>
</body>
</html>
