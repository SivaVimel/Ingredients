<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ingredients</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            height: 100vh; /* Ensures the background takes the full viewport height */
            margin: 0; /* Removes any default margin */
            padding: 0; /* Removes any default padding */
            box-sizing: border-box; /* Ensures padding and borders are included in the element's total width and height */
        }
        /* Fixed header styling */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

.total-products {
    background-color: #4CAF50; /* Slightly darker background */
    border: 2px solid white;
    padding: 5px 10px;
    border-radius: 5px;
    margin-left: 15px; /* Space between the heading and the total count */
    font-size: 16px;
    color: white;
}
        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .header .add-button {
            background-color: white;
            color: #4CAF50;
            padding: 10px 20px;
            margin-right: 50px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px; /* Add margin to offset the fixed header */
        }

        table, th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f4f4f4;
        }
        tr {
            background-color: #f4f4f4;
        }

        form {
            margin-top: 20px;
        }

        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Black background with opacity */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .close-button {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 16px;
            float: right;
        }

        .form-container label {
            display: block;
            margin-bottom: 10px;
            text-align: left;
        }

        .form-container input {
            width: 100%;
            padding: 8px;
            margin: 5px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .add-button:hover {
            background-color: #3e8e41;
            color: white;
        }
        .prod-headings {
    margin-top: 110px;
    margin-left: 30px;
    text-align: center;
    color: #fff;
    -webkit-text-stroke: 2px #4CAF50;
    font-weight: bold;
    font-size: 30px;
    text-transform: uppercase;
    background: linear-gradient(to right, #4CAF50, #fff);
    -webkit-background-clip: text;
    color: transparent;
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
    letter-spacing: 1px;
    transition: all 0.3s ease;
}

.prod-headings:hover {
    color: #4CAF50;
    text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
    transform: scale(1.05);
}

.product-table {
    display: block; /* Hidden by default, will be shown when the heading is clicked */
}

    </style>
    <style>
        .popup {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }
        
        .popup img {
            max-width: 90%;
            max-height: 90%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .popup .close-button {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 69px;
            color: white;
            cursor: pointer;
            background: transparent;
            border: none;
        }
        /* The close button */
.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}
.scroll-bruh {
    max-height: 250px; /* Limit the height */
    overflow-y: auto;  /* Enable vertical scrolling */
    padding-right: 10px; /* Adds space to the right of the list for the scrollbar */
}

#loginPopup {
    display: none; /* Hide by default to prevent flickering */
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(41, 41, 41, 0.932);
    z-index: 1001;
    overflow: hidden;
}

#loginPopup .popup-content {
    margin-top: 10%;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    width: 500px;
    height: 500px;
    z-index: 2;
}

#loginPopup input {
    width: 90%;
    height:10%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #4CAF50;
    border-radius: 5px;
}

#loginPopup button {
    background: #4CAF50;
    color: white;
    padding: 15px 30px; /* Increased padding for larger size */
    font-size: 18px; /* Increased font size */
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#loginPopup button:hover {
    background: #45a049;
}

/* Container for table to enable scroll */
.table-container {
    max-height: 300px;  /* Set the height to limit the visible area */
    overflow-y: auto;   /* Enable vertical scrolling */
    width: 100%;        /* Ensure the container takes up full width */
}

/* Make sure the table itself is styled correctly */
.order-table {
    width: 100%;        /* Ensure the table stretches to full container width */
    border-collapse: collapse;  /* Optional: to make the table look cleaner */
}


        /* Hide the page content when login popup is visible */
        .hidden {
            display: none;
        }
        
        .aspect-ratio-9-16 {
    width: 50px;
    height: 88.89px;
    object-fit: cover;
}

#cart-content {
    display: none;
    position: fixed;
    top: 50px;
    left: 50%;
    transform: translateX(-50%);
    background: rgb(27, 27, 27);
    padding: 20px;
    border: 2px solid #ccc;
    border-radius: 10px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 80vh;
    overflow: hidden;
    width: 80%;
}

/* Cart table styling */
#cart-table {
    background-color: #252525;
    color: white;
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed; /* Ensures equal column width */
}

/* Keep header fixed */
#cart-table thead {
    display: table;
    width: 100%;
    table-layout: fixed;
}

/* Scrollable cart body */
#cart-table tbody {
    display: block;
    max-height: 300px;
    overflow-y: auto;
    width: 100%;
}

/* Table row styling */
#cart-table tr {
    display: table;
    width: 100%;
    table-layout: fixed;
}

/* Table headers and cells */
#cart-table th, #cart-table td {
    border: 1px solid white;
    padding: 10px;
    text-align: left;
    background-color: #252525;
}

/* Header background */
#cart-table th {
    background-color: #333;
}

nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
    font-family: Arial, sans-serif;
}

nav a {
    text-decoration: none;
    background-color: #007bff; /* Primary blue */
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    font-size: 16px;
    transition: background-color 0.3s, transform 0.2s;
}

nav a:hover {
    background-color: #0056b3; /* Darker blue */
    transform: scale(1.05);
}

nav a:active {
    background-color: #004494; /* Even darker on click */
    transform: scale(0.98);
}

nav span {
    font-size: 16px;
    font-weight: bold;
    color: aqua;
}

#notepad-popup751 {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            background: #f8f8f8;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        /* Scrollable textarea */
        #notepad-text751 {
            width: 100%;
            height: 150px;
            overflow-y: auto;
            resize: none;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        .popup-overlay751 {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        </style>     
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>   
        <script>
            function toggleOrderHistory() {
            const historyDiv = document.getElementById("order-history");
            historyDiv.style.display = historyDiv.style.display === "none" ? "block" : "none";
        }
        </script>
    <script>
        function openModal() {
            document.getElementById("productModal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("productModal").style.display = "none";
            
        }
        function openModal2() {
            document.getElementById("productModal2").style.display = "flex";
        }

        function closeModal2() {
            document.getElementById("productModal2").style.display = "none";
        }

        function openOrderModal(id, name, category, costPrice, sellingPrice, quantity) {
            document.getElementById("orderModal").style.display = "flex";
            document.getElementById("order-id").value = id;
            document.getElementById("order-name").value = name;
            document.getElementById("order-category").value = category;
            document.getElementById("order-cost-price").value = costPrice;
            document.getElementById("order-selling-price").value = sellingPrice;
            document.getElementById("order-quantity").value = quantity;
        }

        function closeOrderModal() {
            document.getElementById("orderModal").style.display = "none";
        }
    </script>
    <script>
        // Function to get the total products based on the highest product ID
function calculateTotalProducts() {
    const productList = document.querySelectorAll('#product-list li');
    let lastProductId = 0;

    // Loop through the product list to find the highest ID
    productList.forEach(product => {
        const productId = parseInt(product.id.split('-')[1]); // Extracts the ID number from product-1
        if (productId > lastProductId) {
            lastProductId = productId;
        }
    });

    return lastProductId;
}

// Function to update the total product count in the header
function updateProductCount() {
    const totalProducts = calculateTotalProducts();
    document.getElementById('product-count').textContent = totalProducts;
}

// Call the function to update the count
updateProductCount();
        // Function to toggle the visibility of the product table

// Ensure that all tables are visible when the page loads
window.onload = function() {
    var tables = document.querySelectorAll('.product-table');
    tables.forEach(function(table) {
        table.style.display = "block";  // Set all tables to be visible on load
    });
};

        // Function to display the popup with the clicked image
        function showPopup(imageSrc) {
            const popup = document.getElementById("imagePopup");
            const popupImage = document.getElementById("popupImage");
            popup.style.display = "flex"; // Show the popup
            popupImage.src = imageSrc; // Set the image source to the clicked image
        }
    
        // Function to close the popup when the close button is clicked
        function closePopup() {
            const popup = document.getElementById("imagePopup");
            popup.style.display = "none"; // Hide the popup
        }
        
        function searchTable() {
    const input = document.getElementById("searchInput");
    const filter = input.value.toLowerCase();
    const categories = document.querySelectorAll(".category-section"); // All categories
    let anyCategoryVisible = false; // Flag to track if any category is visible after filtering

    categories.forEach(categoryDiv => {
        const table = categoryDiv.querySelector(".product-table table tbody");
        const rows = table.getElementsByTagName("tr");
        let categoryHasVisibleRows = false;

        // Check each row in the table
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName("td");
            let rowContainsText = false;

            // Check each cell in the row for search text
            for (let j = 0; j < cells.length; j++) {
                if (cells[j].innerText.toLowerCase().indexOf(filter) > -1) {
                    rowContainsText = true;
                    break;
                }
            }

            // Toggle row visibility based on search match
            rows[i].style.display = rowContainsText ? "" : "none";

            // If any row in the category has a match, mark category as visible
            if (rowContainsText) {
                categoryHasVisibleRows = true;
            }
        }

        // Toggle visibility of the entire category based on the presence of matching rows
        if (categoryHasVisibleRows) {
            categoryDiv.style.display = "block"; // Show category
            anyCategoryVisible = true;
        } else {
            categoryDiv.style.display = "none"; // Hide category if no rows match
        }
    });

    // Ensure at least one category is always visible (in case nothing matches)
    if (!anyCategoryVisible) {
        document.getElementById("categories").style.display = "none"; // Optional: Hide entire container if no results found
    } else {
        document.getElementById("categories").style.display = "block"; // Show if any result matches
    }
}
    </script>  
         
</head>
<body>
    <!-- Login Popup -->
    <div id="loginPopup">
        
        <center><div class="popup-content">
            <h2 style="color:#45a049;">Welcome to Ingredients</h2>
            <input style="margin-top:70px;" type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button style="margin-top:70px;" onclick="login()">Login</button>
            <p id="loginError" style="color: red; display: none;">Invalid credentials. Please try again.</p>
        </div></center>
    </div>
    
    <div id="pageContent">
        <!-- Fixed header -->
        <div class="header">
            <div>
                <div style="margin-left:15px;">
                    <a href="{{ url_for('logout') }}">
                        <img style="width:4%;" src="static/logout.png" alt="logout">
                    </a>                    
                    <img style="width:3.7%; margin-left:15px; cursor: pointer;" src="static/notification.png" alt="Orders" onclick="toggleOrderHistory()">
                    <img style="width:3.7%; margin-left:15px; cursor: pointer;" src="static/cart.png" alt="Cart" onclick="viewCart()">
                    
                    <div id="cart-content">
                        <button onclick="closeCart()" style="float: right; background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 5px;">X</button>
                        <h2>Your Cart</h2>
                        <table id="cart-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Quantity</th>
                                    <th>Message</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cart-tbody"></tbody>
                        </table>
                        <button style="border:none; border-radius: 5px; background-color: #fffb00; width: 100%; font-size:medium;" onclick="submitCart()">Place Order</button>
                    </div>
                    
<!-- Hidden User Input (Dynamically pass username from Flask) -->
<input type="hidden" id="username751" value="{{ username }}">

<!-- Clickable Image -->
<img src="static/notes.png" alt="Notepad" onclick="openNotepad751()" style="cursor: pointer; width: 50px; margin-left: 25px;">

<!-- Popup Overlay -->
<div class="popup-overlay751" id="popup-overlay751" onclick="closeNotepad751()"></div>

<!-- Notepad Popup -->
<div id="notepad-popup751">
    <h3 style="color:#333">Wishlist</h3>
    <textarea id="notepad-text751"></textarea>
    <button onclick="saveMessage751()">Save</button>
    <button onclick="closeNotepad751()">Close</button>
</div>

<script>
    // Use the username from the hidden input field
    const username = document.getElementById("username751").value;

    function openNotepad751() {
        fetch(`/get-message?username=${username}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("notepad-text751").value = data.message || "";
                document.getElementById("notepad-popup751").style.display = "block";
                document.getElementById("popup-overlay751").style.display = "block";
            });
    }

    function saveMessage751() {
        const message = document.getElementById("notepad-text751").value;

        fetch('/save-message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, message })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert("Message saved!");
                closeNotepad751();
            } else {
                alert("Failed to save message.");
            }
        });
    }

    function closeNotepad751() {
        document.getElementById("notepad-popup751").style.display = "none";
        document.getElementById("popup-overlay751").style.display = "none";
    }
</script>
                   

<div id="order-history" style="display:none; color:#3e8e41">
    <h3 style="color: #fff;">Your Order History</h3>
    {% if user_orders %}
    <div class="table-container">
        <table class="order-table">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Quantity</th>
                    <th>Action</th> <!-- New column for delete button -->
                </tr>
            </thead>
            <tbody>
                {% for order in user_orders[::-1] %}
                    <tr>
                        <td>{{ order[3] }}</td>
                        <td>{{ order[4] }}</td>
                        <td>{{ order[2] }}</td>
                        <td><button class="delete-button" onclick="deleteOrder('{{ order[1] }}', '{{ order[2] }}')">Delete</button></td> <!-- Delete button -->
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p>No orders found.</p>
    {% endif %}
</div>

                </div>
            </div>
            <script>
                function deleteOrder(productId, orderQuantity) {
                    // Send the product ID and quantity to Flask via an AJAX call
                    fetch('/delete-order2', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ productId: productId, orderQuantity: orderQuantity })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Order deleted successfully!');
                            location.reload(); // Reload the page to update the order history
                        } else {
                            alert('Failed to delete the order.');
                        }
                    });
                }
                function searchPage() {
            const filter = document.getElementById("searchInput").value.toLowerCase();
            const categories = document.querySelectorAll(".category-section");
            let anyCategoryVisible = false;

            categories.forEach(categoryDiv => {
                const textContent = categoryDiv.innerText.toLowerCase();
                if (textContent.includes(filter)) {
                    categoryDiv.style.display = "block";
                    anyCategoryVisible = true;
                } else {
                    categoryDiv.style.display = "none";
                }
            });

            document.getElementById("categories").style.display = anyCategoryVisible ? "block" : "none";
        }

            </script>
            <h1 style="margin-right:15px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-style: italic; font-weight: 300;letter-spacing: 0.5px;">Welcome {{ username }}
                <span><input type="text" id="searchInput" placeholder="Search..." onkeyup="searchTable()"></span>
                <span style="margin-left:15px; margin-right:50px;">
                    <!-- CATEGORY DROPDOWN -->
                    <span style="margin-left:15px; margin-right:50px;">
                        <select id="category-select" onchange="filterCategory()">
                            <option value="">--All Categories--</option>
                            {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>                                       
                    </span>

                </span>
            </h1>
        </div>
        <script>
            let hasTriggeredLoad = false; // Flag to prevent multiple triggers

document.getElementById("searchInput").addEventListener("focus", function () {
    if (!hasTriggeredLoad) {
        hasTriggeredLoad = true; // Prevent re-triggering

        let scrollEvent = new Event('scroll', { bubbles: true });
        let times = 10; // Adjust the number of scroll triggers

        let interval = setInterval(() => {
            if (times-- > 0) {
                window.dispatchEvent(scrollEvent); // Simulate scroll event
            } else {
                clearInterval(interval); // Stop triggering after a few times
            }
        }, 500); // Adjust timing as needed
    }
});

        </script>
    
        <!-- Modal for the add product form -->
        <div id="productModal" class="modal">
            <div class="modal-content">
                <button onclick="closeModal()" class="close-button">&times; Close</button>
                <h2>Add Product</h2>
                <form method="POST" action="/" enctype="multipart/form-data" class="form-container">
                    <label>Product Name: <input type="text" name="name" required></label>
                    <label>Category: <input type="text" name="category" required></label>
                    <label>Cost Price: <input type="number" name="cost_price" hidden></label>
                    <label>Selling Price: <input type="number" name="selling_price" required></label>
                    <label>Quantity: <input type="number" name="quantity" required></label>
                    <div class="form-group">
                        <label for="image">Product Image</label>
                        <input type="file" name="image" id="image" class="form-control" accept="image/*">
                    </div>
                    <button type="submit" class="add-button">Add Product</button>
                </form>            
            </div>
        </div>
        <div id="cart-popup" style="
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: aqua;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    z-index: 9999;
">
    <img src="static/trolley.png" alt="Added to Cart" style="width: 100px; height: 100px;">
</div>
    <!-- Product Categories and Tables -->
    <!-- Product Categories and Tables -->
    <div id="categories"></div>

    <!-- Loading Indicator -->
    <div id="loading" class="loading-text" style="display: none; text-align:center;">Loading more products...</div>
    
    <script>
    let start = 0;
    const limit = 5; // Load 5 categories at a time
    let loading = false;
    let allLoaded = false;
    let allProducts = {}; // Store all loaded products globally

    async function loadMoreProducts() {
        if (loading || allLoaded) return;
        loading = true;
        document.getElementById("loading").style.display = "block";

        let response = await fetch(`/client?load_more=true&start=${start}`);
        let data = await response.json();

        let newProducts = data.products;
        if (Object.keys(newProducts).length === 0) {
            allLoaded = true;
            document.getElementById("loading").innerText = "No more products.";
            return;
        }

        Object.assign(allProducts, newProducts); // Store globally for filtering
        renderProducts(newProducts);
        updateCategoryDropdown();
        start += limit;
        loading = false;
        document.getElementById("loading").style.display = "none";

        if (!data.has_more) {
            allLoaded = true;
            document.getElementById("loading").innerText = "No more products.";
        }
    }


    function renderProductsByCategory(category, products) {
    let container = document.getElementById("categories");

    let categoryDiv = document.createElement("div");
    categoryDiv.className = "category-section";
    categoryDiv.id = `category-${category}`;

    categoryDiv.innerHTML = `
        <h2 class="prod-headings" onclick="toggleTableVisibility('table-${category}')">${category}</h2>
        <div class="product-table">
            <table id="table-${category}" class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Selling Price</th>
                        <th>Quantity</th>
                        <th>Expiry</th>
                        <th>Image</th>
                        <th>Order</th>
                    </tr>
                </thead>
                <tbody>
                    ${products.map(product => `
                        <tr id="product-${product[0]}">
                            <td>${product[0]}</td>
                            <td>${product[1]}</td>
                            <td>${product[2]}</td>
                            <td>${parseFloat(product[4]).toFixed(2)}</td>
                            <td>
                                ${product[5] == 0 
                                    ? `<button type="button" class="notify-button" style="font-size:large; background-color: #f44336; color: #fff;" onclick="sendNotifyRequest('${product[0]}', '${product[1]}', '${product[2]}')">Notify</button>`
                                    : product[5]}
                            </td>
                            <td>${product[8]}</td> 
                            <td>
                                ${product[6] 
                                    ? `<img src="/uploads/${product[6]}" class="aspect-ratio-9-16" onclick="showPopup('/uploads/${product[6]}')">`
                                    : "No Image"}
                            </td>
                            <td>
                                ${product[5] > 0 
                                    ? `<input type="number" style="width: 60px; padding: 6px; border: 2px solid #ccc; border-radius: 5px; font-size: 14px; text-align: center; color: white; background-color: #252525;" id="quantity-${product[0]}" placeholder="Qty" min="1" max="${product[5]}" value="1" required>
                                        <input type="text" style="width: 150px; padding: 6px; border: 2px solid #ccc; border-radius: 5px; font-size: 14px; color: white; background-color: #252525;" id="message-${product[0]}" placeholder="Message (Optional)">
                                        <button type="button" class="order-button" onclick="placeOrder('${product[0]}','${product[1]}', '${product[2]}')">Order</button>`
                                    : ""}
                            </td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>
        </div>
    `;

    container.appendChild(categoryDiv);
}


    function toggleTableVisibility(tableId) {
        let table = document.getElementById(tableId);
        if (table) {
            table.style.display = table.style.display === "none" ? "table" : "none";
        }
    }

    function filterCategory() {
    const selectedCategory = document.getElementById("category-select").value;
    let container = document.getElementById("categories");
    
    // Clear previous category products
    container.innerHTML = "";  

    if (selectedCategory === "") {
        // If "All Categories" is selected, load all products
        window.location.reload(); 
        return;
    }

    // Fetch category-specific products from Flask
    fetch(`/get_products/${selectedCategory}`)
        .then(response => response.json())
        .then(products => {
            renderProductsByCategory(selectedCategory, products);
        })
        .catch(error => console.error("Error fetching products:", error));
}


    function renderProducts(products) {
        let container = document.getElementById("categories");
        for (let category in products) {
            if (!document.getElementById(`category-${category}`)) {
                let categoryDiv = document.createElement("div");
                categoryDiv.className = "category-section";
                categoryDiv.id = `category-${category}`;
                categoryDiv.innerHTML = `
                    <h2 class="prod-headings" onclick="toggleTableVisibility('table-${category}')">${category}</h2>
                    <div class="product-table">
                        <table id="table-${category}" class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Selling Price</th>
                                    <th>Quantity</th>
                                    <th>Expiry</th>
                                    <th>Image</th>
                                    <th>Order</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products[category].map(product => `
                                    <tr id="product-${product[0]}">
                                        <td>${product[0]}</td>
                                        <td>${product[1]}</td>
                                        <td>${product[2]}</td>
                                        <td>${product[4]}</td>
                                        <td>
                                            ${product[5] == 0 
                                                ? `<button type="button" class="notify-button" style="font-size:large; background-color: #f44336; color: #fff;" onclick="sendNotifyRequest('${product[0]}', '${product[1]}', '${product[2]}')">Notify</button>`
                                                : product[5]}
                                        </td>
                                        <td>${product[8]}</td> 
                                        <td>
                                            ${product[6] 
                                                ? `<img src="/uploads/${product[6]}" class="aspect-ratio-9-16" onclick="showPopup('/uploads/${product[6]}')">`
                                                : "No Image"}
                                        </td>
                                        <td>
                                            ${product[5] > 0 
                                                ? `<input type="number" style="width: 60px; padding: 6px; border: 2px solid #ccc; border-radius: 5px; font-size: 14px; text-align: center; color: white; background-color: #252525;" id="quantity-${product[0]}" placeholder="Qty" min="1" max="${product[5]}" min="1" max="${product[5]}" value="1" required>
                                                    <input type="text" style="width: 150px; padding: 6px; border: 2px solid #ccc; border-radius: 5px; font-size: 14px; color: white; background-color: #252525;" id="message-${product[0]}" placeholder="Message (Optional)">
                                                    <button type="button" class="order-button" onclick="placeOrder('${product[0]}','${product[1]}', '${product[2]}')">Order</button>`
                                                : ""}
                                        </td>
                                    </tr>
                                `).join("")}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(categoryDiv);
            }
        }
    }

    function toggleTableVisibility(tableId) {
        let table = document.getElementById(tableId);
        if (table) {
            table.style.display = table.style.display === "none" ? "table" : "none";
        }
    }

    
    function updateCategoryDropdown() {
        let categorySelect = document.getElementById("category-select");
        let existingCategories = new Set([...categorySelect.options].map(opt => opt.value));

        for (let category in allProducts) {
            if (!existingCategories.has(category)) {
                let option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            }
        }
    }

    window.addEventListener("scroll", function () {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
            loadMoreProducts();
        }
    });

    window.onload = loadMoreProducts;
    </script>
    

    <script>
        document.addEventListener("DOMContentLoaded", function () {
    // Restore scroll position
    const scrollPosition = localStorage.getItem("scrollPosition");
    if (scrollPosition) {
        window.scrollTo(0, parseInt(scrollPosition, 10));
    }

    // Save scroll position before page unload
    window.addEventListener("beforeunload", function () {
        localStorage.setItem("scrollPosition", window.scrollY);
    });
});

        function placeOrder(productId, productName, productCat) {
    const quantity = document.getElementById(`quantity-${productId}`).value;
    const message = document.getElementById(`message-${productId}`).value;

    if (!quantity || quantity <= 0) {
        alert('Please enter a valid quantity.');
        return;
    }

    // Add product to cart (sessionStorage or session variable in Flask)
    fetch('/add-to-cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            'id': productId,
            'product_name': productName,
            'product_cat':productCat,
            'order_quantity': quantity,
            'order_Message': message
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showCartPopup();  // Show popup when added to cart
        } else {
            alert("Failed to add to cart.");
        }
    });

function showCartPopup() {
    const popup = document.getElementById("cart-popup");
    popup.style.display = "block";  // Show popup
    setTimeout(() => {
        popup.style.display = "none";  // Hide after 1 second
    }, 1000);
}

}
function closeCart() {
    document.getElementById("cart-content").style.display = "none";
}
function viewCart() {
    fetch('/view-cart')
    .then(response => response.json())
    .then(cartItems => {
        let cartTable = document.getElementById("cart-tbody");
        cartTable.innerHTML = '';  // Clear the cart table

        cartItems.forEach(item => {
            let row = document.createElement("tr");
            row.innerHTML = `
                <td>${item.name}</td>
                <td><input style="width:80%;" type="number" value="${item.quantity}" id="edit-quantity-${item.product_id}"></td>
                <td><input style="width:80%;" type="text" value="${item.message}" id="edit-message-${item.product_id}"></td>
                <td><button style="border: none;
    border-radius: 5px;
    width: 100%;
    font-size: medium;
    padding: 10px;
    margin-top: 10px;
    cursor: pointer;" onclick="updateCartItem(${item.product_id})">Update</button></td>
            `;
            cartTable.appendChild(row);
        });

        document.getElementById("cart-content").style.display = 'block';
    });
}

function updateCartItem(productId) {
    const quantity = document.getElementById(`edit-quantity-${productId}`).value;
    const message = document.getElementById(`edit-message-${productId}`).value;

    fetch('/update-cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            'id': productId,
            'order_quantity': quantity,
            'order_Message': message
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert("Cart updated!");
            viewCart(); // Refresh the cart view
        } else {
            alert("Failed to update cart.");
        }
    });
}

function submitCart() {
    fetch('/submit-cart', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert("Order placed successfully!");
            window.location.reload();  // Reload the page to reflect changes
        } else {
            alert(result.message);  // Show the detailed error message
        }
    });
}



        function sendNotifyRequest(productId, productName, productCategory) {
            fetch('/notify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    product_id: productId,
                    product_name: productName,
                    product_category: productCategory
                })
            })
            .then(response => response.json())
        }
    </script>
    

    <!-- JavaScript to Filter and Show/Hide Categories -->
    <script>

    
    </script>
        <div id="imagePopup" class="popup">
            <span class="close-button" onclick="closePopup()">&times;</span>
            <img id="popupImage" src="" alt="Product Image">
        </div>
    </div>

    <script>

// Handle resizing
window.addEventListener("resize", () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    drops.length = Math.floor(canvas.width / 20);
});

        // Function to handle login
        document.addEventListener("DOMContentLoaded", function () {
    const showLoginPopup = {{ show_login_popup | default(false) | tojson }};
    const loginPopup = document.getElementById("loginPopup");

    if (showLoginPopup) {
        // Show login popup if required
        loginPopup.style.display = "flex";  
    } else {
        // Hide login popup initially
        loginPopup.style.display = "none";
    }
});

// Login Function
async function login() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    const loginError = document.getElementById("loginError");

    try {
        const response = await fetch("/validate-login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ username, password })
        });

        if (response.ok) {
            // If login is successful, update session and reload the page
            localStorage.setItem("isLoggedIn", "true"); // Store login status
            document.getElementById("loginPopup").style.display = "none";
            document.getElementById("pageContent").classList.remove("hidden");
            location.reload(); 
        } else {
            loginError.style.display = "block";
        }
    } catch (error) {
        console.error("Login failed:", error);
        loginError.style.display = "block";
        loginError.textContent = "An error occurred. Please try again.";
    }
}

    </script>
    <script>

        // Toggle the display of the order history
        function toggleOrderHistory() {
            const historyDiv = document.getElementById("order-history");
            historyDiv.style.display = historyDiv.style.display === "none" ? "block" : "none";
        }
    </script>
</body>
</html>
